<!DOCTYPE html>
<meta charset="utf-8">
<style>
h1{
  font-family: 'Noto Sans','Noto Sans Hebrew', serif;
  font-size: 18px;
  text-align: center;
}
path {
  stroke: #fff;
}
path:hover{
  opacity: 0.8;
}
</style>

<body>
  <h1>Localbudget Sunburst Sandbox</h1>
  <script src="//d3js.org/d3.v3.js"></script>
  <script>
  var width = 960,
  height = 960,
  radius = (Math.min(width, height) / 2) - 10;

  var formatNumber = d3.format(",d");

  //ההיקף
  var x = d3.scale.linear()
  .range([0, 2 * Math.PI]);

  //העומק
  var y = d3.scale.sqrt()
  .range([0, radius]);

  var color = d3.scale.category20c();

  var partition = d3.layout.partition()
  .value(function(d) {
    return d.amount;
  });

  var arc = d3.svg.arc()
  .startAngle(function(d) {
    return Math.max(0, Math.min(2 * Math.PI, x(d.x)));
  })
  .endAngle(function(d) {
    return Math.max(0, Math.min(2 * Math.PI, x(d.x + d.dx)));
  })
  .innerRadius(function(d) {
    return Math.max(0, y(d.y));
  })
  .outerRadius(function(d) {
    return Math.max(0, y(d.y + d.dy));
  });

  var svg = d3.select("body").append("svg")
  .attr("width", width)
  .attr("height", height)
  .append("g")
  .attr("transform", "translate(" + width / 2 + "," + (height / 2) + ")");


  d3.json("get_budget_tree.json", function(error, root) {
    if (error) throw error;

    svg.selectAll("path")
    .data(partition.nodes(root))
    .enter().append("path")
    .attr("d", arc)
    .style("fill", function(d) {
      return color((d.children ? d : d.parent).name);
    })
    .on("click", click)
    .append("title")
    .text(function(d) {
      return d.name + "\n" + formatNumber(d.value) + "\nקוד: " + d.code;
    });
  });

  function click(d) {

    d3.select("h1").text
    (
      function () {
        node = d;
        var text = node.muni;
        while (node.name !== 'root'){
          text = text + ' : ' + node.name;
          node = node.parent;
        }
        return text
      }
    );

    svg.transition()
    .duration(1500)
    .tween("scale", function() {
      var xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]),
      yd = d3.interpolate(y.domain(), [d.y, 1]),
      yr = d3.interpolate(y.range(), [d.y ? 20 : 0, radius]);
      return function(t) {
        x.domain(xd(t));
        y.domain(yd(t)).range(yr(t));
      };
    })
    .selectAll("path")
    .attrTween("d", function(d) {
      return function() {
        return arc(d);
      };
    });


  }

  d3.select(self.frameElement).style("height", height + "px");
  </script>
</body>
